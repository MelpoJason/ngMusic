var mainModule=angular.module("MainModule",[]),SERVERURL="http://121.40.81.63:3000/node/";mainModule.directive("loadchannel",["$rootScope","MusicService","MessageService",function(n,e,t){return{restrict:"AE",link:function(o,i){i.on("click",function(o){o.stopPropagation();var a=i.attr("data-id");n.name="随心听: "+i.attr("data-name"),n.$apply(),e.updateList(a),t.channelChange(),t.loadingBroadcast(!0,"加载中...")})}}}]),mainModule.directive("pauseaudio",["MusicService",function(n){return{restrict:"A",link:function(e,t){t.on("click",function(e){e.stopPropagation(),n.playorpauseSong()})}}}]),mainModule.directive("removespan",["MusicService","MessageService",function(n){return{restrict:"A",link:function(e,t){t.on("click",function(e){e.stopPropagation();var o=t.parent().attr("data-index"),i=n.getSetting("isUsrPlay");i?n.removeSong(o):n.addOneSong(o,!0)})}}}]),mainModule.directive("playaudio",["MusicService",function(n){return{restrict:"AE",link:function(e,t){t.on("click",function(e){e.stopPropagation();var o=t.attr("data-index");n.getSetting("searchMode")?(n.addOneSong(o),n.changePlayer(0)):n.playSong(o)})}}}]),mainModule.directive("detectiveenter",["MusicService",function(n){return{restrict:"AE",link:function(e,t){t.on("keydown",function(e){13===e.keyCode&&n.changePlayer(2,t[0].value)})}}}]),mainModule.directive("progressdiv",["MusicService",function(n){return{restrict:"AE",link:function(e,t){function o(e){if(i){var o=t[0].getBoundingClientRect(),s=r.getBoundingClientRect().width,c=e.x-o.left;c>s?c=s:c>o.width&&(c=o.width),a.style.width=c+"px",n.setAudiocurrentTime(c/o.width)}return e.stopPropagation(),e.preventDefault(),!1}var i=!1,a=document.getElementById("currentprogress"),r=document.getElementById("loadedprogress");t.on("mousedown",function(){i=!0,document.addEventListener("mousemove",o)}),document.addEventListener("mouseup",function(n){o(n),i=!1,document.removeEventListener("mousemove",o)})}}}]),mainModule.service("MusicService",["$http","$q","$rootScope","MessageService",function(n,e,t,o){function i(n,e){for(var t in n)e.hasOwnProperty(t)&&(n[t]=e[t])}function a(){var n={};for(var e in b)b.hasOwnProperty(e)&&"audioList"!=e&&"channelList"!=e&&(n[e]=b[e]);setTimeout(function(){localStorage.setItem("shang_music",JSON.stringify({setting:n,userSongIds:x}))})}function r(){E?(E.style.width=v()*C+"px",T.style.width=I.currentTime/I.duration*C+"px"):(E=document.getElementById("loadedprogress"),w=document.getElementById("progressbar"),T=document.getElementById("currentprogress"),C=w.getBoundingClientRect().width||0)}function s(){c((b.currentIndex+1)%b.audioList.length)}function c(n){L(),(n||0===n)&&(b.currentIndex=parseInt(n)),-1===b.currentIndex||b.currentIndex>=b.audioList.length||(u(),a())}function u(){I.src=b.audioList[b.currentIndex].songLink,I.play(),b.isplaying=!0,t.alltime=d(b.audioList[b.currentIndex].time),t.$broadcast("current.update"),t.currentIndex=b.currentIndex,o.toastBroadcast(!0,b.audioList[b.currentIndex].songName,2e3),R=shangLrcLoad.getInstance(I,"lrcdiv"),R.loadNewLrc("",0),n.get(SERVERURL+"serverjson?url=http://music.baidu.com"+b.audioList[b.currentIndex].lrcLink).success(function(n){R.loadNewLrc(n.data,0)}).error(function(){R.loadNewLrc("[00:00]未找到(┬＿┬)",0)})}function d(n){n=n||I.currentTime;var e=Math.floor(n/60),t=Math.round(n%60)<10?"0"+Math.round(n%60):Math.round(n%60);return e+":"+t}function g(n){R&&I&&(R.setRepaireTimeNu(parseInt(R.getRepaireTimeNu())+parseInt(n)),o.toastBroadcast(!0,R.getRepaireTimeNu()/10+"",3e3))}function l(n,e){if(!n||!n.data||!n.data.songList)return void(b.audioList=[]);var t=n.data.songList,o=t.filter(function(n){return n.songLink&&/file\.qianqian\.com/.test(n.songLink)&&!/serverget\?url/.test(n.songLink)?n.songLink="http://cors4ngmusic.coding.io/?fun=fun&url="+encodeURIComponent(n.songLink):n.songLink&&(n.songLink=n.songLink.replace("http://yinyueshiting.baidu.com/data2/music/","http://musicdata.baidu.com/data2/music/")),n.rate});b.audioList=o,e&&($=o)}function p(t){if(t&&(t=t.trim())){var o=e.defer();return n.get(SERVERURL+"serverget?url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+t+"&version=2&from=0")).success(function(n){o.resolve(n)}).error(function(n){o.resolve("")}),o.promise}}function f(){var t=e.defer();return n.get(SERVERURL+"getchannellist").success(function(n){t.resolve(n.channel_list)}).error(function(n){t.reject(n)}),t.promise}function h(t){var o=e.defer();return n.get(SERVERURL+"getsonglink?id="+t).success(function(n){o.resolve(n)}).error(function(n){o.reject(n)}),o.promise}function m(n){var e=h(n);e.then(function(n){l(n),t.$broadcast("aduioList.update")},function(n){b.audioList=[],t.$broadcast("aduioList.update")})}function y(){var n=f();n.then(function(n){b.channelList=n;var e=Math.floor(Math.random()*n.length);m(e),o.channelChange(),o.loadingBroadcast(!0,n[e].channel_name),t.name=n[e].channel_name},function(n){})}function v(){if(!I)return 0;var n=I.buffered;if(n.length){var e=n.end(n.length-1);return e/I.duration}}function L(){E&&T&&(E.style.width="0px",T.style.width="0px")}function S(n){var e=parseInt(n);return 1===b.audioList.length||-1>=e?(b.audioList=[],x=[],b.currentIndex=-1,t.$broadcast("clear"),void a()):(e===b.currentIndex&&s(),b.audioList.splice(e,1),x.splice(e,1),e<=b.currentIndex&&(b.currentIndex-=1),t.currentIndex=b.currentIndex,t.$broadcast("searchback.update"),void a())}var M,P=null,I=new Audio,R=null,x=[5963228],$=[],b={currentHadPlayedNu:0,audioList:[],currentIndex:-1,playMode:0,isUsrPlay:!0,isplaying:!1,channelList:[],searchMode:!1},k=localStorage.getItem("shang_music");if(k)try{var B=JSON.parse(k);M=B.setting||{},x=B.userSongIds||[]}catch(U){M={},x=[]}finally{i(b,M)}I.onerror=function(){/\/null$/.test(I.src)||(b.currentHadPlayedNu<=2?setTimeout(function(){I.src=b.audioList[b.currentIndex].songLink,I.play(),b.currentHadPlayedNu++},500):(clearTimeout(P),P=setTimeout(function(){b.currentHadPlayedNu=0,o.toastBroadcast(!0,"加载失败,播放下一首(┬＿┬)",1e3),s()},1e3)))},I.ontimeupdate=function(){t.time=d(),t.$apply(),r()},I.onended=function(){if(1===b.playMode)c(b.currentIndex);else if(0===b.playMode)s();else{var n=b.audioList.length;c(Math.floor(Math.random()*n))}};var E=document.getElementById("loadedprogress"),w=document.getElementById("progressbar"),T=document.getElementById("currentprogress"),C=0;return t.$on("clear",function(){R=shangLrcLoad(I,"lrcdiv"),R.parseLrc(""),R.setRepaireTimeNu(0),R.init(),I.src=null,I.load()}),{channelList:f,songlink:h,getSongInfo:function(t){var o=e.defer();return n.get(SERVERURL+"getsonginfo?id="+t).success(function(n){o.resolve(n)}).error(function(n){o.reject(n)}),o.promise},updateList:m,getAudioList:function(){return b.audioList},playSong:c,playorpauseSong:function(n){n?(I.pause(),b.isplaying=!1):(I.play(),b.isplaying=!0)},playNextSong:s,playPrevSong:function(){this.playSong((b.currentIndex-1+b.audioList.length)%b.audioList.length)},getCurrentSong:function(){return b.audioList[b.currentIndex]},changePlayer:function(e,i){if(o.loadingBroadcast(!0,"加载中"),b.searchMode=!1,b.isUsrPlay=0===e,0===e){for(var a=!0,r=$.slice(0).sort(function(n,e){return n.songId-e.songId}),s=x.slice(0).sort(function(n,e){return n-e}),c=0;c<s.length;c++)r[c]&&s[c]===r[c].songId||(a=!1);if(a)return b.isUsrPlay=!0,b.audioList=$,t.$broadcast("mode.update"),void o.loadingBroadcast();o.loadingBroadcast(!0,"自定义播放列表"),n.get(SERVERURL+"getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:x}))).success(function(n){l(n,!0),b.isUsrPlay=!0,t.$broadcast("mode.update"),o.loadingBroadcast()}).error(function(n){o.loadingBroadcast()})}else if(1===e)o.loadingBroadcast(),y();else if(2===e){b.searchMode=!0,o.loadingBroadcast(!0,"搜索"+i+"中...");var u=p(i);if(!u)return o.toastBroadcast(!0,"请输入内容",3e3),void o.loadingBroadcast();u.then(function(e){b.isUsrPlay=!1;var i=e.data.song;i=i.map(function(n){return n.songid}),n.get(SERVERURL+"getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:i}))).success(function(n){l(n),t.$broadcast("search.update"),o.loadingBroadcast()}).error(function(n){o.loadingBroadcast()})})}else 3===e&&(o.loadingBroadcast(),b.audioList=$,b.isUsrPlay=!0,t.$broadcast("searchback.update"))},searchSong:p,addOneSong:function(n,e){for(var t=b.audioList[n],i=-1,r=0;r<$.length;r++)if($[r].songId===t.songId){i=r;break}-1===i?(x.push(t.songId),$.push(t),b.currentIndex=$.length-1,o.toastBroadcast(!0,"添加成功~",3e3)):(e&&(b.currentIndex=i),o.toastBroadcast(!0,"已经存在~",3e3)),e||(b.audioList=$),a()},removeSong:S,getSetting:function(n){return b.hasOwnProperty(n)?b[n]:""},setSetting:function(n,e){b.hasOwnProperty(n)&&(b[n]=e)},setAudiocurrentTime:function(n){try{I.currentTime=n*I.duration}catch(e){I.setAudiocurrentTime&&I.setAudiocurrentTime(n-10>0?n-10:0)}},clearProgress:L,changeLrcTime:g}}]),mainModule.service("MessageService",["$rootScope",function(n){var e=null,t=!1,o="",i=!1,a="";return{loadingBroadcast:function(n,e){this.setLoading(n||!1),this.setLoadingMsg(e||""),this.broadcast()},setLoading:function(n){t=n},getLoading:function(){return t},setLoadingMsg:function(n){o=n},getLoadingMsg:function(){return o},toastBroadcast:function(n,t,o){if(this.settoast(n||!1),this.settoastMsg(t||""),this.broadcast(),parseInt(o)){var i=this;clearTimeout(e),e=setTimeout(function(){i.toastBroadcast(!1)},parseInt(o))}},settoast:function(n){i=n},gettoast:function(){return i},settoastMsg:function(n){a=n},gettoastMsg:function(){return a},broadcast:function(){n.$broadcast("message.update")},channelChange:function(){n.$broadcast("channel.toggle")}}}]),mainModule.controller("channelCtrl",["$rootScope","$scope","MusicService","MessageService",function(n,e,t,o){function i(){e.channels=t.getSetting("channelList"),e.showhide=a?"eleDownIn":"eleDownOut",a=!a}e.isLoading=!0,e.isUsrPlay=t.getSetting("isUsrPlay"),e.toggleChannel=i,e.$on("channel.toggle",i);var a=!1;e.togglePlayer=function(){var n=t.getSetting("isUsrPlay");e.isUsrPlay=!n,a=!1,e.showhide="eleDownOut",n?(o.loadingBroadcast(!0,"切换到随心听..."),t.changePlayer(1)):(o.loadingBroadcast(!0,"切换到用户列表..."),t.changePlayer(0))}}]),mainModule.controller("listCtrl",["$rootScope","$scope","MusicService","MessageService",function(n,e,t,o){function i(n){e.songs=t.getAudioList(),o.loadingBroadcast(),t.playSong(n),e.songs.length&&o.toastBroadcast(!0,e.songs[n].songName,2e3)}e.songs=[],e.search={},n.$on("clear",function(){e.songs=[],e.$apply()}),n.$on("aduioList.update",function(){e.isUsrPlay=!1,e.isadd=!0,i(0)}),n.$on("mode.update",function(){var o=t.getSetting("isUsrPlay");n.name=o?"播放列表":"随心听",e.isUsrPlay=o,e.issearch=!1,e.isadd=!o;var a=t.getSetting("currentIndex");(a>t.getAudioList().length||-1>=a)&&(a=0),i(a)}),n.$on("searchback.update",function(){var o=t.getSetting("isUsrPlay");n.name=o?"播放列表":"随心听",e.isUsrPlay=o,e.issearch=!1,e.isadd=!1,e.songs=t.getAudioList()}),n.$on("search.update",function(){e.isUsrPlay=!1,e.issearch=!0,n.name="搜索 "+e.search.name+" 的结果",e.songs=t.getAudioList()}),e.backUsr=function(){t.changePlayer(3)},e.searchSong=function(){t.changePlayer(2,e.search.name)},e.isUsrPlay=t.getSetting("isUsrPlay");var a=navigator.userAgent;return/AppleWebKit\/(\S+)/.test(a)?void t.changePlayer(e.isUsrPlay?0:1):void(n.name="本网页只支持chrome内核浏览器\n\r原因:在不使用flash下\r\n只有chrome支持播放mp3")}]),mainModule.controller("musciCtrl",["$rootScope","$scope","MusicService",function(n,e,t){e.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},e.playMode=t.getSetting("playMode"),e.isPlaying=t.getSetting("isplaying"),e.changePlaying=function(){t.playorpauseSong(e.isPlaying),e.isPlaying=t.getSetting("isplaying")},n.$on("current.update",function(){n.time=null;var o=t.getCurrentSong();e.isPlaying=t.getSetting("isplaying"),e.song=o,o.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png";var i=t.getSongInfo(o.songId);i.then(function(n){var t=n.data.songList;if(t&&t.length){var o=t[0],i=o.songPicRadio;o.songPicRadio=i?/http:\/\/qukufile2\.qianqian\.com/.test(i)?i.match(/http:\/\/qukufile2\.qianqian\.com.*?jpg/)[0]:SERVERURL+"serverget?url="+encodeURIComponent(o.songPicRadio):"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png",e.song.songPicRadio=o.songPicRadio}},function(n){e.song.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"})}),n.$on("clear",function(){n.time=null,n.alltime=null,e.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},e.playMode=t.getSetting("playMode"),e.isPlaying=!1,n.$apply(),e.$apply(),t.clearProgress(),t.setSetting("isplaying",!1)}),e.prev=function(){t.playPrevSong()},e.next=function(){t.playNextSong()},e.changeLoop=function(){t.setSetting("playMode",(parseInt(e.playMode)+1)%3),e.playMode=t.getSetting("playMode")},e.changeLrc=function(n){t.changeLrcTime(n)}}]),mainModule.controller("messageCtrl",["$rootScope","$scope","MessageService",function(n,e,t){e.$on("message.update",function(){e.isLoading=t.getLoading(),e.loadingMsg=t.getLoadingMsg(),e.isToast=t.gettoast(),e.toastMsg=t.gettoastMsg()})}]);